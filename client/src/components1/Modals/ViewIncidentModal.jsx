import React from 'react';
import { createPortal } from 'react-dom';
import { BASE_URL } from '../../config';
import './ViewIncidentModal.css';

function ViewIncidentModal({ 
  showModal, 
  selectedIncident, 
  currentUser,
  onClose, 
  onMarkAsResolved, 
  onAssignTanod 
}) {
  if (!showModal || !selectedIncident) return null;

  const getStatusClass = (status) => {
    switch (status?.toLowerCase()) {
      case 'resolved':
        return 'status-resolved';
      case 'in progress':
      case 'ongoing':
        return 'status-progress';
      case 'pending':
      case 'new':
        return 'status-pending';
      default:
        return '';
    }
  };

  const getPriorityClass = (priority) => {
    switch (priority?.toLowerCase()) {
      case 'high':
      case 'critical':
        return 'priority-high';
      case 'medium':
      case 'normal':
        return 'priority-medium';
      case 'low':
        return 'priority-low';
      default:
        return '';
    }
  };

  const handleImageClick = (imageSrc) => {
    const imageOverlay = document.createElement('div');
    imageOverlay.className = 'image-viewer-overlay';
    
    const img = document.createElement('img');
    img.src = imageSrc;
    img.alt = 'Incident Evidence - Full Size';
    
    imageOverlay.appendChild(img);
    imageOverlay.onclick = () => {
      document.body.removeChild(imageOverlay);
    };
    
    // Add escape key listener
    const handleEscape = (e) => {
      if (e.key === 'Escape') {
        document.body.removeChild(imageOverlay);
        document.removeEventListener('keydown', handleEscape);
      }
    };
    
    document.addEventListener('keydown', handleEscape);
    document.body.appendChild(imageOverlay);
  };

  const formatDateTime = (dateString) => {
    if (!dateString) return 'Not available';
    
    try {
      const date = new Date(dateString);
      return date.toLocaleString('en-US', {
        year: 'numeric',
        month: 'short',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        hour12: true
      });
    } catch (error) {
      return 'Invalid date';
    }
  };

  const isResolved = selectedIncident.status?.toLowerCase() === 'resolved';

  return createPortal(
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal-container" onClick={(e) => e.stopPropagation()}>
        {/* Header */}
        <div className="modal-header">
          <h2>Incident Report Details</h2>
          <button 
            className="modal-close" 
            onClick={onClose} 
            aria-label="Close modal"
            title="Close (Esc)"
          >
            Ã—
          </button>
        </div>

        {/* Body */}
        <div className="modal-body">
          <div className="modal-info-grid">
            {/* Basic Information Row */}
            <div className="modal-info-row">
              <div className="modal-field">
                <label>Incident ID</label>
                <div className="modal-value incident-id">
                  INC-{String(selectedIncident.id).padStart(6, '0')}
                </div>
              </div>
              <div className="modal-field">
                <label>Status</label>
                <div className={`modal-value ${getStatusClass(selectedIncident.status)}`}>
                  {selectedIncident.status || 'Unknown'}
                </div>
              </div>
            </div>

            {/* Type and Priority Row */}
            <div className="modal-info-row">
              <div className="modal-field">
                <label>Incident Type</label>
                <div className="modal-value">
                  {selectedIncident.incident_type || 'Not specified'}
                </div>
              </div>
              <div className="modal-field">
                <label>Priority</label>
                <div className={`modal-value ${getPriorityClass(selectedIncident.priority)}`}>
                  {selectedIncident.priority || 'Normal'}
                </div>
              </div>
            </div>

            {/* Location and Reporter Row */}
            <div className="modal-info-row">
              <div className="modal-field">
                <label>Location</label>
                <div className="modal-value">
                  {selectedIncident.location || "Not specified"}
                </div>
              </div>
              <div className="modal-field">
                <label>Reported By</label>
                <div className="modal-value">
                  {selectedIncident.reported_by || "Anonymous"}
                </div>
              </div>
            </div>

            {/* Timestamps Row */}
            <div className="modal-info-row">
              <div className="modal-field">
                <label>Reported Time</label>
                <div className="modal-value timestamp">
                  {formatDateTime(selectedIncident.datetime)}
                </div>
              </div>
              {selectedIncident.resolved_at && (
                <div className="modal-field">
                  <label>Resolved Time</label>
                  <div className="modal-value timestamp">
                    {formatDateTime(selectedIncident.resolved_at)}
                  </div>
                </div>
              )}
            </div>

            {/* Assignment Information */}
            {(selectedIncident.assigned_tanod || selectedIncident.resolved_by) && (
              <div className="modal-info-row">
                {selectedIncident.assigned_tanod && (
                  <div className="modal-field">
                    <label>Assigned Tanod</label>
                    <div className="modal-value">
                      {selectedIncident.assigned_tanod}
                    </div>
                  </div>
                )}
                {selectedIncident.resolved_by && (
                  <div className="modal-field">
                    <label>Resolved By</label>
                    <div className="modal-value">
                      {selectedIncident.resolved_by}
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* Description */}
            {selectedIncident.description && (
              <div className="modal-info-row single-column">
                <div className="modal-field">
                  <label>Description</label>
                  <div className="modal-description">
                    {selectedIncident.description}
                  </div>
                </div>
              </div>
            )}

            {/* Evidence Photo */}
            {selectedIncident.image && (
              <div className="modal-info-row single-column">
                <div className="modal-field">
                  <label>Evidence Photo</label>
                  <div className="modal-image-container">
                    <img 
                      src={`${BASE_URL}/uploads/${selectedIncident.image}`} 
                      alt="Incident evidence" 
                      className="modal-image"
                      onClick={() => handleImageClick(`${BASE_URL}/uploads/${selectedIncident.image}`)}
                      onError={(e) => {
                        e.target.style.display = 'none';
                        e.target.parentNode.innerHTML = '<div class="image-placeholder">Evidence photo not available</div>';
                      }}
                      title="Click to view full size"
                    />
                  </div>
                </div>
              </div>
            )}

            {/* Additional Notes */}
            {selectedIncident.notes && (
              <div className="modal-info-row single-column">
                <div className="modal-field">
                  <label>Additional Notes</label>
                  <div className="modal-description">
                    {selectedIncident.notes}
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>

        {/* Footer */}
        <div className="modal-footer">
          <div style={{ marginRight: 'auto', fontSize: '12px', color: '#6b7280' }}>
            Last updated: {formatDateTime(selectedIncident.updated_at || selectedIncident.datetime)}
          </div>
          
          {!isResolved && (
            <>
              <button 
                className="btn resolve-btn" 
                onClick={onMarkAsResolved}
                aria-label="Mark incident as resolved"
              >
                <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
                  <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                </svg>
                Mark as Resolved
              </button>
              <button 
                className="btn secondary" 
                onClick={onAssignTanod}
                aria-label="Assign tanod to incident"
              >
                <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z" />
                </svg>
                Assign Tanod
              </button>
            </>
          )}
          <button 
            className="btn close" 
            onClick={onClose}
            aria-label="Close modal"
          >
            Close
          </button>
        </div>
      </div>
    </div>,
    document.body
  );
}

export default ViewIncidentModal;